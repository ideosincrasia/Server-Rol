<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tienda DnD</title>
  <style>
    :root {
      --bg: #e7e7e7; /* pergamino */
      --surface: #ffffff;
      --primary: #a36b03; /* oro */
      --accent: #daa520; /* dorado */
      --text: #333333;
      --muted: #777777;
      --radius: 12px;
      --gap: 1rem;
      --shadow: rgba(0, 0, 0, 0.5);
    }
    * { box-sizing: border-box; margin: 0; padding: 0 }
    html, body {
      height: 100%;
      font-family: sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    
    .container {
      display: grid;
      grid-template-columns: 200px 1fr;
      grid-template-rows: auto 1fr;
      grid-template-areas:
        "nav header"
        "nav main";
      height: 100vh;
    }
    /* NAV */
    nav {
      grid-area: nav;
      background: var(--surface);
      padding: var(--gap);
      border-right: 1px solid #eee;
      position: sticky;
      top: 0;
      overflow-y: auto;
      z-index: 5;
    }
    nav h2 {
      margin-bottom: .75rem;
      font-size: 1.1rem;
      color: var(--primary);
      font-weight: 500;
    }
    nav .tag {
      padding: .6rem;
      background: #f0f0f0;
      border-radius: var(--radius);
      cursor: pointer;
      text-align: center;
      font-size: .9rem;
      margin-bottom: .5rem;
      transition: background .2s, color .2s;
    }
    nav .tag.active,
    nav .tag:hover {
      background: var(--primary);
      color: #fff;
    }
    /* HEADER */
    header {
      grid-area: header;
      background: var(--surface);
      padding: var(--gap);
      border-bottom: 1px solid #eee;
      position: sticky;
      top: 0;
      z-index: 4;
      display: flex;
      align-items: center;
      gap: var(--gap);
    }
    #hamburger {
      display: none;
      width: 32px; height: 32px;
      background: var(--primary);
      border: none; border-radius: 4px;
      color: #fff; font-size: 1.5rem;
      cursor: pointer;
    }
    #search {
      flex: 1;
      padding: .75rem 1rem;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      font-size: 1rem;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
    }
    #search:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(128, 0, 0, 0.2);
    }
    /* MAIN */
    main {
      grid-area: main;
      padding: var(--gap);
      overflow-y: auto;
      background: var(--bg);
    }
    #products {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: var(--gap);
      margin-top: var(--gap);
    }
    .card {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: 0 2px 6px var(--shadow);
      padding: var(--gap);
      text-align: center;
      transition: transform .2s, box-shadow .2s;
      display: flex; flex-direction: column;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px var(--shadow);
    }
    .card h3 {
      font-size: 1rem; margin-bottom: .5rem;
      color: var(--primary); flex: 1;
    }
    .card p { font-weight: bold; margin-bottom: .75rem; }
    .counter {
      display: flex; align-items: center; justify-content: center;
      gap: .5rem;
    }
    .counter button {
      width: 28px; height: 28px;
      border: none; background: var(--primary);
      color: #fff; border-radius: 4px;
      font-size: 1rem; cursor: pointer;
      transition: background .2s;
    }
    .counter button:hover {
      background: var(--accent);
    }
    .counter span {
      min-width: 20px; text-align: center; font-weight: 500;
    }
    /* CART PANEL */
    #cart-panel {
      position: fixed; bottom: var(--gap); right: var(--gap);
      max-height: 340px; background: var(--surface);
      border-radius: var(--radius); box-shadow: 4px 8px 16px var(--shadow);
      padding: calc(var(--gap) + 1rem); overflow-y: auto; display: none; z-index: 5;
    }
    #cart-panel.show { display: block; z-index: 1; }
    #cart-panel h2 {
      margin-bottom: .5rem; font-size: 1.1rem;
      color: var(--primary); text-align: center;
    }
    #cart-table {
      width: 100%; border-collapse: collapse; margin-bottom: .5rem;
    }
    #cart-table th,
    #cart-table td {
      padding: .25rem .5rem; font-size: .85rem;
    }
    #cart-table th {
      font-weight: 600; color: var(--muted);
    }
    #cart-total {
      text-align: right; font-weight: 600; margin-bottom: .5rem;
    }
    /* inc/dec inline, styled */
    #cart-table td.controls {
      display: flex; justify-content: flex-end; align-items: center; gap: .25rem;
    }
    #cart-table .inc,
    #cart-table .dec {
      width: 24px; height: 24px;
      border: none; background: var(--primary);
      color: #fff; border-radius: 4px;
      font-size: .9rem; cursor: pointer;
      transition: background .2s;
    }
    #cart-table .inc:hover,
    #cart-table .dec:hover {
      background: var(--accent);
    }
    #cart-actions {
      display: flex; gap: .5rem; margin-top: .5rem;
    }
    #cart-actions button {
      flex: 1; padding: .5rem; border: none;
      background: var(--primary); color: #fff;
      border-radius: var(--radius); cursor: pointer;
      font-size: .9rem; transition: background .2s;
    }
    #cart-actions button:hover {
      background: var(--accent);
    }

    /* Responsive: hamburger */
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-areas:
          "header"
          "main";
      }
      #hamburger { display: block }
      nav {
        position: fixed; top: 0; left: -220px;
        width: 200px; height: 100%; transition: left .3s;
      }
      nav.show { left: 0 }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- NAV -->
    <nav id="sidebar">
      <h2>Categorías</h2>
      <div class="tag active" data-cat="All">Todos</div>
      <% categorias.forEach(cat => { %>
        <div class="tag" data-cat="<%= cat %>"><%= cat %></div>
      <% }) %>
    </nav>

    <!-- HEADER -->
    <header>
      <button id="hamburger">☰</button>
      <input id="search" type="text" placeholder="Buscar productos..." />
    </header>

    <!-- PRODUCTOS -->
    <main>
      <div id="products">
        <% productos.forEach(item => { %>
          <div class="card"
               data-cat="<%= item.category %>"
               data-name="<%= item.name.toLowerCase() %>"
               data-price-currency="<%= item.marketPrice.currency %>">
            <h3><%= item.name %></h3>
            <p><%= item.marketPrice.amount %> <%= item.marketPrice.currency %></p>
            <div class="counter" data-name="<%= item.name %>">
              <button class="minus">−</button>
              <span class="count">0</span>
              <button class="plus">+</button>
            </div>
          </div>
        <% }) %>
      </div>
    </main>
  </div>

  <!-- CART PANEL -->
  <aside id="cart-panel">
    <h2>Carrito</h2>
    <table id="cart-table">
      <thead><tr><th>Item</th><th>.ctn</th></tr></thead>
      <tbody id="cart-body"></tbody>
    </table>
    <div id="cart-total"></div>
    <div id="cart-actions">
      <button id="goto-cart">Comprar</button>
      <button id="clear-cart">Vaciar</button>
    </div>
  </aside>

  <script>
    const sidebar = document.getElementById('sidebar');
    const hamburger = document.getElementById('hamburger');
    hamburger.addEventListener('click', ()=> sidebar.classList.toggle('show'));

    // close sidebar when clicking outside
    document.addEventListener('click', e => {
      if (sidebar.classList.contains('show') &&
         !sidebar.contains(e.target) &&
         e.target !== hamburger) {
        sidebar.classList.remove('show');
      }
    });

    const tags      = document.querySelectorAll("nav .tag");
    const cards     = document.querySelectorAll(".card");
    const search    = document.getElementById("search");
    const panel     = document.getElementById("cart-panel");
    const bodyTbl   = document.getElementById("cart-body");
    const totalEl   = document.getElementById("cart-total");
    const clearBtn  = document.getElementById("clear-cart");
    const gotoBtn   = document.getElementById("goto-cart");
    let cart        = JSON.parse(localStorage.getItem("cart") || "{}");
    let currentCat  = "All";

    addEventListener("DOMContentLoaded", ()=>{
      // Initialize cart from localStorage
      if (!cart || typeof cart !== 'object') {
        cart = {};
        localStorage.setItem("cart", JSON.stringify(cart));
      }
      // Update counters
      cards.forEach(card => {
        const name = card.dataset.name;
        const count = cart[name] || 0;
        card.querySelector(".count").textContent = count;
      });
      updateCartPanel();
    });

    function generateDiscordMessage() {
      const productos = <%- JSON.stringify(productos) %>;

      const bought = productos
        .filter(p => cart[p.name] > 0)
        .map(p => ({
          name: p.name,
          count: cart[p.name],
          price: p.marketPrice
        }))

      const name = '[Nombre del personaje]'
      const lines = bought.map(i => `- ${i.count} ${i.name}`)
      const msg = `${name} compra:\n${lines.join('\n')}`
      
      return msg;
    }

    function filterCards() {
      const term = search.value.trim().toLowerCase();
      cards.forEach(card => {
        const okCat = currentCat === "All" || card.dataset.cat === currentCat;
        const okTxt = !term || card.dataset.name.includes(term);
        card.style.display = okCat && okTxt ? "" : "none";
      });
    }
    tags.forEach(tag => tag.addEventListener("click", ()=>{
      tags.forEach(t=>t.classList.remove("active"));
      tag.classList.add("active");
      currentCat = tag.dataset.cat;
      filterCards();
    }));
    search.addEventListener("input", filterCards);

    function updateCartPanel() {
      bodyTbl.innerHTML = "";
      let value=0, has=false;
      cards.forEach(card=>{
        const name = card.querySelector(".counter").dataset.name;
        const qty  = cart[name]||0;
        if(!qty) return;
        has = true;
        const amt = parseFloat(card.querySelector("p").textContent);
        const mul = card.dataset.priceCurrency==='gold'?100: card.dataset.priceCurrency==='silver'?10 : 1;
        value += amt*mul*qty;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${name}</td>
          <td class="controls">
            <button class="dec" data-name="${name}">−</button>
            <span>${qty}</span>
            <button class="inc" data-name="${name}">+</button>
          </td>`;
        bodyTbl.appendChild(tr);
      });

      panel.classList.toggle("show", has);
          const gp = Math.floor(value/100)
          let rem = value % 100
          const sp = Math.floor(rem/10)
          const cp = rem % 10
      totalEl.textContent = `Total: ${gp} oro, ${sp} plata, ${cp} cobre`;

      // Add event listeners for increment/decrement buttons
      document.querySelectorAll("#cart-body .inc").forEach(btn=>{
        btn.onclick = ()=>{
          const n = btn.dataset.name;
          cart[n] = (cart[n]||0)+1;
          localStorage.setItem("cart", JSON.stringify(cart));
          document.querySelector(`.card[data-name="${n.toLowerCase()}"] .count`)
            .textContent = cart[n];
          updateCartPanel();
        };
      });
      document.querySelectorAll("#cart-body .dec").forEach(btn=>{
        btn.onclick = ()=>{
          const n = btn.dataset.name;
          if((cart[n]||0)>0) cart[n]--;
          localStorage.setItem("cart", JSON.stringify(cart));
          document.querySelector(`.card[data-name="${n.toLowerCase()}"] .count`)
            .textContent = cart[n];
          updateCartPanel();
        };
      });
    }

    // Initialize counters
    cards.forEach(card=>{
      const ctr = card.querySelector(".counter");
      const n   = ctr.dataset.name;
      const sp  = ctr.querySelector(".count");
      ctr.querySelector(".plus").onclick = ()=>{
        cart[n] = (cart[n]||0)+1;
        sp.textContent = cart[n];
        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartPanel();
      };
      ctr.querySelector(".minus").onclick = ()=>{
        if((cart[n]||0)>0){
          cart[n]--;
          sp.textContent = cart[n];
          localStorage.setItem("cart", JSON.stringify(cart));
          updateCartPanel();
        }
      };
    });

    // Cards Buttons
    gotoBtn.addEventListener("click", ()=> {
    window.location.href = 'discord://discord.com/channels/1302041074092478555/1303562045811326996';
          const txt = generateDiscordMessage();
      if (!txt) return
      navigator.clipboard.writeText(txt).then(() => {
        const btn = document.getElementById('goto-cart');
        btn.textContent = 'Comprado!';
        setTimeout(() => btn.textContent = 'Detalles', 1500);
      });
    });

    clearBtn.addEventListener("click", ()=>{
      Object.keys(cart).forEach(k=>cart[k]=0);
      localStorage.setItem("cart", JSON.stringify(cart));
      document.querySelectorAll(".count").forEach(el=>el.textContent=0);
      updateCartPanel();
    });
    filterCards();
    updateCartPanel();
  </script>
</body>
</html>
