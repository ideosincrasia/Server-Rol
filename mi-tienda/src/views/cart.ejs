<!-- views/cart.ejs -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Carrito – Tienda DnD</title>
  <style>
    body { font-family: sans-serif; max-width:600px; margin:auto; padding:2rem }
    label, button, textarea, pre, p, a { display: block; width: 100%; margin-bottom: 1rem }
    input[type="text"] { width: auto; padding: .5rem; }
    pre { background:#f4f4f4; padding:1rem; border-radius:4px; overflow:auto }
    textarea { height: 6rem; padding: .5rem; resize: vertical; }
    button { padding: .5rem; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Carrito de compra</h1>

  <label>
    Nombre del personaje:
    <input id="charName" type="text" placeholder="Ej. Thargrim Barbabronce">
  </label>

  <button id="genDiscord">Generar mensaje Discord</button>

  <textarea id="discordMessage" readonly placeholder="Aquí aparecerá tu mensaje para Discord"></textarea>
  <button id="copyDiscord">Copiar mensaje</button>

  <pre id="json"></pre>

  <p>Total: <strong id="total"></strong></p>

  <a href="/shop">← Volver</a>

  <script>
    const productos = <%- JSON.stringify(productos) %>;

    const cart      = JSON.parse(localStorage.getItem('cart')||'{}')

    // construir lista de comprados
    const bought = productos
      .filter(p => cart[p.name] > 0)
      .map(p => ({
        name: p.name,
        count: cart[p.name],
        price: p.marketPrice
      }))

    // mostrar JSON
    document.getElementById('json').textContent = JSON.stringify(bought, null, 2)

    // calcular total
    let totalCopper = 0
    bought.forEach(item => {
      const { amount, currency } = item.price
      const mul = currency==='gold'?100 : currency==='silver'?10 : 1
      totalCopper += amount * mul * item.count
    })
    const gp = Math.floor(totalCopper/100)
    let rem = totalCopper % 100
    const sp = Math.floor(rem/10)
    const cp = rem % 10
    document.getElementById('total').textContent =
      `${gp} oro, ${sp} plata, ${cp} cobre`

    // generar mensaje Discord
    function generateDiscordMessage() {
      const name = document.getElementById('charName').value.trim() || '[Nombre del personaje]'
      const lines = bought.map(i => `- ${i.count} ${i.name}`)
      const msg = `${name} compra:\n${lines.join('\n')}`
      document.getElementById('discordMessage').value = msg
    }
    document.getElementById('genDiscord')
      .addEventListener('click', generateDiscordMessage)

    // copiar al portapapeles
    document.getElementById('copyDiscord').addEventListener('click', () => {
      const txt = document.getElementById('discordMessage').value
      if (!txt) return
      navigator.clipboard.writeText(txt).then(() => {
        const btn = document.getElementById('copyDiscord')
        btn.textContent = '¡Copiado!'
        setTimeout(() => btn.textContent = 'Copiar mensaje', 1500)
      })
    })
  </script>
</body>
</html>
